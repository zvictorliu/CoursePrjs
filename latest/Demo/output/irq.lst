


ARM Macro Assembler    Page 1 


    1 00000000         ;/****************************************Copyright (c)*
                       *************************************************
    2 00000000         ;**                               Guangzou ZLG-MCU Devel
                       opment Co.,LTD.
    3 00000000         ;**                                      graduate school
                       
    4 00000000         ;**                                 http://www.zlgmcu.co
                       m
    5 00000000         ;**
    6 00000000         ;**--------------File Info------------------------------
                       -------------------------------------------------
    7 00000000         ;** File Name: IRQ.s
    8 00000000         ;** Last modified Date:  2004-06-14
    9 00000000         ;** Last Version: 1.1
   10 00000000         ;** Descriptions: The irq handle that what allow the int
                       errupt nesting. 
   11 00000000         ;**
   12 00000000         ;**-----------------------------------------------------
                       -------------------------------------------------
   13 00000000         ;** Created By: Chenmingji
   14 00000000         ;** Created date:   2004-09-17
   15 00000000         ;** Version: 1.0
   16 00000000         ;** Descriptions: First version
   17 00000000         ;**
   18 00000000         ;**-----------------------------------------------------
                       -------------------------------------------------
   19 00000000         ;** Modified by:
   20 00000000         ;** Modified date:
   21 00000000         ;** Version:
   22 00000000         ;** Descriptions:
   23 00000000         ;**
   24 00000000         ;*******************************************************
                       *************************************************/
   25 00000000         
   26 00000000         
   27 00000000                 INCLUDE          irq.inc     ; Inport the head f
                                                            ile ÒýÈëÍ·ÎÄ¼þ
    1 00000000         ;/****************************************Copyright (c)*
                       *************************************************
    2 00000000         ;**                               ¹ãÖÝÖÜÁ¢¹¦µ¥Æ¬»ú·¢Õ¹ÓÐ
                       ÏÞ¹«Ë¾
    3 00000000         ;**                                     ÑÐ    ¾¿    Ëù
    4 00000000         ;**                                        ²úÆ·Ò»²¿ 
    5 00000000         ;**
    6 00000000         ;**                                 http://www.zlgmcu.co
                       m
    7 00000000         ;**
    8 00000000         ;**--------------ÎÄ¼þÐÅÏ¢-------------------------------
                       -------------------------------------------------
    9 00000000         ;**ÎÄ   ¼þ   Ãû: IRQ.inc
   10 00000000         ;**´´   ½¨   ÈË: ³ÂÃ÷¼Æ
   11 00000000         ;**×îºóÐÞ¸ÄÈÕÆÚ: 2004Äê8ÔÂ27ÈÕ
   12 00000000         ;**Ãè        Êö: ¶¨ÒåIRQ»ã±à½Ó¿Ú´úÂëºê
   13 00000000         ;**
   14 00000000         ;**--------------ÀúÊ·°æ±¾ÐÅÏ¢---------------------------
                       -------------------------------------------------
   15 00000000         ;** ´´½¨ÈË: ³ÂÃ÷¼Æ
   16 00000000         ;** °æ  ±¾: v1.0
   17 00000000         ;** ÈÕ¡¡ÆÚ: 2004Äê8ÔÂ27ÈÕ



ARM Macro Assembler    Page 2 


   18 00000000         ;** Ãè¡¡Êö: Ô­Ê¼°æ±¾
   19 00000000         ;**
   20 00000000         ;**--------------µ±Ç°°æ±¾ÐÞ¶©---------------------------
                       ---------------------------------------------------
   21 00000000         ;** ÐÞ¸ÄÈË:
   22 00000000         ;** ÈÕ¡¡ÆÚ:
   23 00000000         ;** Ãè¡¡Êö:
   24 00000000         ;**
   25 00000000         ;**-----------------------------------------------------
                       -------------------------------------------------
   26 00000000         ;*******************************************************
                       *************************************************/
   27 00000000         
   28 00000000 00000080 
                       NoInt   EQU              0x80
   29 00000000         
   30 00000000 00000010 
                       USR32Mode
                               EQU              0x10
   31 00000000 00000013 
                       SVC32Mode
                               EQU              0x13
   32 00000000 0000001F 
                       SYS32Mode
                               EQU              0x1f
   33 00000000 00000012 
                       IRQ32Mode
                               EQU              0x12
   34 00000000 00000011 
                       FIQ32Mode
                               EQU              0x11
   35 00000000         
   36 00000000         
   37 00000000         ;ÒýÈëµÄÍâ²¿±êºÅÔÚÕâÉùÃ÷
   38 00000000                 IMPORT           OSIntCtxSw  ;ÈÎÎñÇÐ»»º¯Êý
   39 00000000                 IMPORT           OSIntExit   ;ÖÐ¶ÏÍË³öº¯Êý
   40 00000000                 IMPORT           OSTCBCur
   41 00000000                 IMPORT           OSTCBHighRdy
   42 00000000                 IMPORT           OSIntNesting ;ÖÐ¶ÏÇ¶Ì×¼ÆÊýÆ÷
   43 00000000                 IMPORT           StackUsr
   44 00000000                 IMPORT           OsEnterSum
   45 00000000         
   46 00000000                 CODE32
   47 00000000         
   48 00000000                 AREA             IRQ,CODE,READONLY
   49 00000000         
   50 00000000                 MACRO
   51 00000000         $IRQ_Label
                               HANDLER          $IRQ_Exception_Function
   52 00000000         
   53 00000000                 EXPORT           $IRQ_Label  ; Êä³öµÄ±êºÅ
   54 00000000                 IMPORT           $IRQ_Exception_Function 
                                                            ; ÒýÓÃµÄÍâ²¿±êºÅ
   55 00000000         
   56 00000000         $IRQ_Label
   57 00000000                 SUB              LR, LR, #4  ; ¼ÆËã·µ»ØµØÖ·
   58 00000000                 STMFD            SP!, {R0-R3, R12, LR} 
                                                            ; ±£´æÈÎÎñ»·¾³
   59 00000000                 MRS              R3, SPSR    ; ±£´æ×´Ì¬



ARM Macro Assembler    Page 3 


   60 00000000                 STMFD            SP, {R3, SP, LR}^ ; ±£´æÓÃ»§×´Ì
                                                            ¬µÄR3,SP,LR,×¢Òâ²»Ä
                                                            Ü»ØÐ´
   61 00000000         ; Èç¹û»ØÐ´µÄÊÇÓÃ»§µÄSP£¬ËùÒÔºóÃæÒªµ÷ÕûSP
   62 00000000                 LDR              R2,  =OSIntNesting 
                                                            ; OSIntNesting++
   63 00000000                 LDRB             R1, [R2]
   64 00000000                 ADD              R1, R1, #1
   65 00000000                 STRB             R1, [R2]
   66 00000000         
   67 00000000                 SUB              SP, SP, #4*3
   68 00000000         
   69 00000000                 MSR              CPSR_c, #(NoInt | SYS32Mode) 
                                                            ; ÇÐ»»µ½ÏµÍ³Ä£Ê½
   70 00000000                 CMP              R1, #1
   71 00000000                 LDREQ            SP, =StackUsr
   72 00000000         
   73 00000000                 BL               $IRQ_Exception_Function ; µ÷ÓÃc
                                                            ÓïÑÔµÄÖÐ¶Ï´¦Àí³ÌÐò
   74 00000000         
   75 00000000                 MSR              CPSR_c, #(NoInt | SYS32Mode) 
                                                            ; ÇÐ»»µ½ÏµÍ³Ä£Ê½
   76 00000000                 LDR              R2, =OsEnterSum ; OsEnterSum,Ê¹
                                                            OSIntExitÍË³öÊ±ÖÐ¶Ï
                                                            ¹Ø±Õ
   77 00000000                 MOV              R1, #1
   78 00000000                 STR              R1, [R2]
   79 00000000         
   80 00000000                 BL               OSIntExit
   81 00000000         
   82 00000000                 LDR              R2, =OsEnterSum ; ÒòÎªÖÐ¶Ï·þÎñ³
                                                            ÌÐòÒªÍË³ö£¬ËùÒÔOsEn
                                                            terSum=0
   83 00000000                 MOV              R1, #0
   84 00000000                 STR              R1, [R2]
   85 00000000         
   86 00000000                 MSR              CPSR_c, #(NoInt | IRQ32Mode) 
                                                            ; ÇÐ»»»ØirqÄ£Ê½
   87 00000000                 LDMFD            SP, {R3, SP, LR}^ ; »Ö¸´ÓÃ»§×´Ì
                                                            ¬µÄR3,SP,LR,×¢Òâ²»Ä
                                                            Ü»ØÐ´
   88 00000000         ; Èç¹û»ØÐ´µÄÊÇÓÃ»§µÄSP£¬ËùÒÔºóÃæÒªµ÷ÕûSP
   89 00000000                 LDR              R0, =OSTCBHighRdy
   90 00000000                 LDR              R0, [R0]
   91 00000000                 LDR              R1, =OSTCBCur
   92 00000000                 LDR              R1, [R1]
   93 00000000                 CMP              R0, R1
   94 00000000         
   95 00000000                 ADD              SP, SP, #4*3 ; 
   96 00000000                 MSR              SPSR_cxsf, R3
   97 00000000                 LDMEQFD          SP!, {R0-R3, R12, PC}^ 
                                                            ; ²»½øÐÐÈÎÎñÇÐ»»
   98 00000000                 LDR              PC, =OSIntCtxSw ; ½øÐÐÈÎÎñÇÐ»»
   99 00000000                 MEND
  100 00000000         
  101 00000000                 END
   28 00000000         
   29 00000000                 CODE32
   30 00000000         



ARM Macro Assembler    Page 4 


   31 00000000                 AREA             IRQ,CODE,READONLY
   32 00000000         
   33 00000000         
   34 00000000         ;/* ÒÔÏÂÌí¼ÓÖÐ¶Ï¾ä±ú£¬ÓÃ»§¸ù¾ÝÊµ¼ÊÇé¿ö¸Ä±ä */
   35 00000000         ;/* Add interrupt handler here£¬user could change it as 
                       needed */
   36 00000000         
   37 00000000         ;/*ÖÐ¶Ï*/
   38 00000000         ;/*Interrupt*/
   39 00000000         IRQ_Handler
                               HANDLER          IRQ_Exception
   52 00000000         
   53 00000000                 EXPORT           IRQ_Handler ; Êä³öµÄ±êºÅ
   54 00000000                 IMPORT           IRQ_Exception ; ÒýÓÃµÄÍâ²¿±êºÅ
   55 00000000         
   56 00000000         IRQ_Handler
   57 00000000 E24EE004        SUB              LR, LR, #4  ; ¼ÆËã·µ»ØµØÖ·
   58 00000004 E92D500F        STMFD            SP!, {R0-R3, R12, LR} 
                                                            ; ±£´æÈÎÎñ»·¾³
   59 00000008 E14F3000        MRS              R3, SPSR    ; ±£´æ×´Ì¬
   60 0000000C E94D6008        STMFD            SP, {R3, SP, LR}^ ; ±£´æÓÃ»§×´Ì
                                                            ¬µÄR3,SP,LR,×¢Òâ²»Ä
                                                            Ü»ØÐ´
   61 00000010         ; Èç¹û»ØÐ´µÄÊÇÓÃ»§µÄSP£¬ËùÒÔºóÃæÒªµ÷ÕûSP
   62 00000010 E59F20E8        LDR              R2,  =OSIntNesting 
                                                            ; OSIntNesting++
   63 00000014 E5D21000        LDRB             R1, [R2]
   64 00000018 E2811001        ADD              R1, R1, #1
   65 0000001C E5C21000        STRB             R1, [R2]
   66 00000020         
   67 00000020 E24DD00C        SUB              SP, SP, #4*3
   68 00000024         
   69 00000024 E321F09F        MSR              CPSR_c, #(NoInt | SYS32Mode) 
                                                            ; ÇÐ»»µ½ÏµÍ³Ä£Ê½
   70 00000028 E3510001        CMP              R1, #1
   71 0000002C 059FD0D0        LDREQ            SP, =StackUsr
   72 00000030         
   73 00000030 EBFFFFFE        BL               IRQ_Exception ; µ÷ÓÃcÓïÑÔµÄÖÐ¶Ï
                                                            ´¦Àí³ÌÐò
   74 00000034         
   75 00000034 E321F09F        MSR              CPSR_c, #(NoInt | SYS32Mode) 
                                                            ; ÇÐ»»µ½ÏµÍ³Ä£Ê½
   76 00000038 E59F20C8        LDR              R2, =OsEnterSum ; OsEnterSum,Ê¹
                                                            OSIntExitÍË³öÊ±ÖÐ¶Ï
                                                            ¹Ø±Õ
   77 0000003C E3A01001        MOV              R1, #1
   78 00000040 E5821000        STR              R1, [R2]
   79 00000044         
   80 00000044 EBFFFFFE        BL               OSIntExit
   81 00000048         
   82 00000048 E59F20B8        LDR              R2, =OsEnterSum ; ÒòÎªÖÐ¶Ï·þÎñ³
                                                            ÌÐòÒªÍË³ö£¬ËùÒÔOsEn
                                                            terSum=0
   83 0000004C E3A01000        MOV              R1, #0
   84 00000050 E5821000        STR              R1, [R2]
   85 00000054         
   86 00000054 E321F092        MSR              CPSR_c, #(NoInt | IRQ32Mode) 
                                                            ; ÇÐ»»»ØirqÄ£Ê½
   87 00000058 E8DD6008        LDMFD            SP, {R3, SP, LR}^ ; »Ö¸´ÓÃ»§×´Ì



ARM Macro Assembler    Page 5 


                                                            ¬µÄR3,SP,LR,×¢Òâ²»Ä
                                                            Ü»ØÐ´
   88 0000005C         ; Èç¹û»ØÐ´µÄÊÇÓÃ»§µÄSP£¬ËùÒÔºóÃæÒªµ÷ÕûSP
   89 0000005C E59F00A8        LDR              R0, =OSTCBHighRdy
   90 00000060 E5900000        LDR              R0, [R0]
   91 00000064 E59F10A4        LDR              R1, =OSTCBCur
   92 00000068 E5911000        LDR              R1, [R1]
   93 0000006C E1500001        CMP              R0, R1
   94 00000070         
   95 00000070 E28DD00C        ADD              SP, SP, #4*3 ; 
   96 00000074 E16FF003        MSR              SPSR_cxsf, R3
   97 00000078 08FD900F        LDMEQFD          SP!, {R0-R3, R12, PC}^ 
                                                            ; ²»½øÐÐÈÎÎñÇÐ»»
   98 0000007C E59FF090        LDR              PC, =OSIntCtxSw ; ½øÐÐÈÎÎñÇÐ»»
   40 00000080         
   41 00000080         
   42 00000080         ;/*¶¨Ê±Æ÷0ÖÐ¶Ï*/
   43 00000080         ;/*Time0 Interrupt*/
   44 00000080         Timer0_Handler
                               HANDLER          Timer0_Exception
   52 00000080         
   53 00000080                 EXPORT           Timer0_Handler ; Êä³öµÄ±êºÅ
   54 00000080                 IMPORT           Timer0_Exception 
                                                            ; ÒýÓÃµÄÍâ²¿±êºÅ
   55 00000080         
   56 00000080         Timer0_Handler
   57 00000080 E24EE004        SUB              LR, LR, #4  ; ¼ÆËã·µ»ØµØÖ·
   58 00000084 E92D500F        STMFD            SP!, {R0-R3, R12, LR} 
                                                            ; ±£´æÈÎÎñ»·¾³
   59 00000088 E14F3000        MRS              R3, SPSR    ; ±£´æ×´Ì¬
   60 0000008C E94D6008        STMFD            SP, {R3, SP, LR}^ ; ±£´æÓÃ»§×´Ì
                                                            ¬µÄR3,SP,LR,×¢Òâ²»Ä
                                                            Ü»ØÐ´
   61 00000090         ; Èç¹û»ØÐ´µÄÊÇÓÃ»§µÄSP£¬ËùÒÔºóÃæÒªµ÷ÕûSP
   62 00000090 E59F2068        LDR              R2,  =OSIntNesting 
                                                            ; OSIntNesting++
   63 00000094 E5D21000        LDRB             R1, [R2]
   64 00000098 E2811001        ADD              R1, R1, #1
   65 0000009C E5C21000        STRB             R1, [R2]
   66 000000A0         
   67 000000A0 E24DD00C        SUB              SP, SP, #4*3
   68 000000A4         
   69 000000A4 E321F09F        MSR              CPSR_c, #(NoInt | SYS32Mode) 
                                                            ; ÇÐ»»µ½ÏµÍ³Ä£Ê½
   70 000000A8 E3510001        CMP              R1, #1
   71 000000AC 059FD050        LDREQ            SP, =StackUsr
   72 000000B0         
   73 000000B0 EBFFFFFE        BL               Timer0_Exception ; µ÷ÓÃcÓïÑÔµÄÖ
                                                            Ð¶Ï´¦Àí³ÌÐò
   74 000000B4         
   75 000000B4 E321F09F        MSR              CPSR_c, #(NoInt | SYS32Mode) 
                                                            ; ÇÐ»»µ½ÏµÍ³Ä£Ê½
   76 000000B8 E59F2048        LDR              R2, =OsEnterSum ; OsEnterSum,Ê¹
                                                            OSIntExitÍË³öÊ±ÖÐ¶Ï
                                                            ¹Ø±Õ
   77 000000BC E3A01001        MOV              R1, #1
   78 000000C0 E5821000        STR              R1, [R2]
   79 000000C4         
   80 000000C4 EBFFFFFE        BL               OSIntExit



ARM Macro Assembler    Page 6 


   81 000000C8         
   82 000000C8 E59F2038        LDR              R2, =OsEnterSum ; ÒòÎªÖÐ¶Ï·þÎñ³
                                                            ÌÐòÒªÍË³ö£¬ËùÒÔOsEn
                                                            terSum=0
   83 000000CC E3A01000        MOV              R1, #0
   84 000000D0 E5821000        STR              R1, [R2]
   85 000000D4         
   86 000000D4 E321F092        MSR              CPSR_c, #(NoInt | IRQ32Mode) 
                                                            ; ÇÐ»»»ØirqÄ£Ê½
   87 000000D8 E8DD6008        LDMFD            SP, {R3, SP, LR}^ ; »Ö¸´ÓÃ»§×´Ì
                                                            ¬µÄR3,SP,LR,×¢Òâ²»Ä
                                                            Ü»ØÐ´
   88 000000DC         ; Èç¹û»ØÐ´µÄÊÇÓÃ»§µÄSP£¬ËùÒÔºóÃæÒªµ÷ÕûSP
   89 000000DC E59F0028        LDR              R0, =OSTCBHighRdy
   90 000000E0 E5900000        LDR              R0, [R0]
   91 000000E4 E59F1024        LDR              R1, =OSTCBCur
   92 000000E8 E5911000        LDR              R1, [R1]
   93 000000EC E1500001        CMP              R0, R1
   94 000000F0         
   95 000000F0 E28DD00C        ADD              SP, SP, #4*3 ; 
   96 000000F4 E16FF003        MSR              SPSR_cxsf, R3
   97 000000F8 08FD900F        LDMEQFD          SP!, {R0-R3, R12, PC}^ 
                                                            ; ²»½øÐÐÈÎÎñÇÐ»»
   98 000000FC E59FF010        LDR              PC, =OSIntCtxSw ; ½øÐÐÈÎÎñÇÐ»»
   45 00000100         
   46 00000100                 END
              00000000 
              00000000 
              00000000 
              00000000 
              00000000 
              00000000 
Command Line: --debug --xref --diag_suppress=9931,A1608W --apcs=interwork --dep
end=.\output\irq.d -o.\output\irq.o -IE:\software\Keil\Keil_v5\ARM\RV31\INC -IE
:\software\Keil\Keil_v5\ARM\CMSIS\Include -IE:\software\Keil\Keil_v5\ARM\INC\Ph
ilips --predefine="__UVISION_VERSION SETA 526" --list=.\output\irq.lst app\irq.
s



ARM Macro Assembler    Page 1 Alphabetic symbol ordering
Relocatable symbols

IRQ 00000000

Symbol: IRQ
   Definitions
      At line 48 in file app\irq.inc
   Uses
      None
Comment: IRQ unused
IRQ_Handler 00000000

Symbol: IRQ_Handler
   Definitions
      At line 56 in macro HANDLER
      at line 39 in file app\irq.s
   Uses
      At line 53 in macro HANDLER
      at line 39 in file app\irq.s
Comment: IRQ_Handler used once
Timer0_Handler 00000080

Symbol: Timer0_Handler
   Definitions
      At line 56 in macro HANDLER
      at line 44 in file app\irq.s
   Uses
      At line 53 in macro HANDLER
      at line 44 in file app\irq.s
Comment: Timer0_Handler used once
3 symbols



ARM Macro Assembler    Page 1 Alphabetic symbol ordering
Absolute symbols

FIQ32Mode 00000011

Symbol: FIQ32Mode
   Definitions
      At line 34 in file app\irq.inc
   Uses
      None
Comment: FIQ32Mode unused
IRQ32Mode 00000012

Symbol: IRQ32Mode
   Definitions
      At line 33 in file app\irq.inc
   Uses
      At line 86 in macro HANDLER
      at line 39 in file app\irq.s
Comment: IRQ32Mode used once
NoInt 00000080

Symbol: NoInt
   Definitions
      At line 28 in file app\irq.inc
   Uses
      At line 69 in macro HANDLER
      at line 39 in file app\irq.s
      At line 75 in macro HANDLER
      at line 39 in file app\irq.s
      At line 86 in macro HANDLER
      at line 39 in file app\irq.s

SVC32Mode 00000013

Symbol: SVC32Mode
   Definitions
      At line 31 in file app\irq.inc
   Uses
      None
Comment: SVC32Mode unused
SYS32Mode 0000001F

Symbol: SYS32Mode
   Definitions
      At line 32 in file app\irq.inc
   Uses
      At line 69 in macro HANDLER
      at line 39 in file app\irq.s
      At line 75 in macro HANDLER
      at line 39 in file app\irq.s

USR32Mode 00000010

Symbol: USR32Mode
   Definitions
      At line 30 in file app\irq.inc
   Uses
      None
Comment: USR32Mode unused
6 symbols



ARM Macro Assembler    Page 1 Alphabetic symbol ordering
External symbols

IRQ_Exception 00000000

Symbol: IRQ_Exception
   Definitions
      At line 54 in macro HANDLER
      at line 39 in file app\irq.s
   Uses
      At line 73 in macro HANDLER
      at line 39 in file app\irq.s
Comment: IRQ_Exception used once
OSIntCtxSw 00000000

Symbol: OSIntCtxSw
   Definitions
      At line 38 in file app\irq.inc
   Uses
      At line 98 in macro HANDLER
      at line 39 in file app\irq.s
Comment: OSIntCtxSw used once
OSIntExit 00000000

Symbol: OSIntExit
   Definitions
      At line 39 in file app\irq.inc
   Uses
      At line 80 in macro HANDLER
      at line 39 in file app\irq.s
Comment: OSIntExit used once
OSIntNesting 00000000

Symbol: OSIntNesting
   Definitions
      At line 42 in file app\irq.inc
   Uses
      At line 62 in macro HANDLER
      at line 39 in file app\irq.s
Comment: OSIntNesting used once
OSTCBCur 00000000

Symbol: OSTCBCur
   Definitions
      At line 40 in file app\irq.inc
   Uses
      At line 91 in macro HANDLER
      at line 39 in file app\irq.s
Comment: OSTCBCur used once
OSTCBHighRdy 00000000

Symbol: OSTCBHighRdy
   Definitions
      At line 41 in file app\irq.inc
   Uses
      At line 89 in macro HANDLER
      at line 39 in file app\irq.s
Comment: OSTCBHighRdy used once
OsEnterSum 00000000

Symbol: OsEnterSum
   Definitions



ARM Macro Assembler    Page 2 Alphabetic symbol ordering
External symbols

      At line 44 in file app\irq.inc
   Uses
      At line 76 in macro HANDLER
      at line 39 in file app\irq.s
      At line 82 in macro HANDLER
      at line 39 in file app\irq.s

StackUsr 00000000

Symbol: StackUsr
   Definitions
      At line 43 in file app\irq.inc
   Uses
      At line 71 in macro HANDLER
      at line 39 in file app\irq.s
Comment: StackUsr used once
Timer0_Exception 00000000

Symbol: Timer0_Exception
   Definitions
      At line 54 in macro HANDLER
      at line 44 in file app\irq.s
   Uses
      At line 73 in macro HANDLER
      at line 44 in file app\irq.s
Comment: Timer0_Exception used once
9 symbols
351 symbols in table
